#!/bin/bash
# ofxPiMapper Build Configuration
# This file contains the main configuration for automated image builds

################################################################################
# System Configuration
################################################################################

# Raspberry Pi user account
RPI_USERNAME="${RPI_USERNAME:-mapper}"
RPI_PASSWORD="${RPI_PASSWORD:-projection}"

# System hostname
HOSTNAME="${HOSTNAME:-ofxpimapper}"

# Timezone (e.g., America/New_York, Europe/London, Asia/Tokyo)
TIMEZONE="${TIMEZONE:-UTC}"

# Locale settings
LOCALE="${LOCALE:-en_US.UTF-8}"
KEYBOARD_LAYOUT="${KEYBOARD_LAYOUT:-us}"

################################################################################
# Raspberry Pi OS Configuration
################################################################################

# Base image type: "lite" or "desktop"
# - lite: Minimal console-only system (smaller, faster)
# - desktop: Full desktop environment (recommended for GUI applications)
BASE_IMAGE="${BASE_IMAGE:-desktop}"

# Architecture: "armhf" (32-bit) or "arm64" (64-bit)
# Note: openFrameworks currently has better support for 32-bit
ARCHITECTURE="${ARCHITECTURE:-armhf}"

# Raspberry Pi OS release: "bullseye" (Debian 11) or "bookworm" (Debian 12)
RPI_OS_RELEASE="${RPI_OS_RELEASE:-bookworm}"

################################################################################
# openFrameworks Configuration
################################################################################

# openFrameworks version (0.12.0 or later recommended)
OF_VERSION="${OF_VERSION:-0.12.0}"

# openFrameworks platform
# - linuxarmv7l: 32-bit ARM (Raspberry Pi, armhf)
# - linuxaarch64: 64-bit ARM (arm64)
OF_PLATFORM="${OF_PLATFORM:-linuxarmv7l}"

# openFrameworks download URL (auto-constructed if not set)
OF_DOWNLOAD_URL="${OF_DOWNLOAD_URL:-https://github.com/openframeworks/openFrameworks/releases/download/${OF_VERSION}/of_v${OF_VERSION}_${OF_PLATFORM}_release.tar.gz}"

# Installation directory
OF_ROOT="${OF_ROOT:-/home/${RPI_USERNAME}/openFrameworks}"

################################################################################
# ofxPiMapper Configuration
################################################################################

# ofxPiMapper repository
OFXPIMAPPER_REPO="${OFXPIMAPPER_REPO:-https://github.com/b0rt/ofxPiMapper.git}"
OFXPIMAPPER_BRANCH="${OFXPIMAPPER_BRANCH:-master}"

# Example project to compile (example_basic, example_simpler, example_fbo-sources, etc.)
COMPILE_EXAMPLE="${COMPILE_EXAMPLE:-example_simpler}"

# Additional examples to compile (space-separated)
ADDITIONAL_EXAMPLES="${ADDITIONAL_EXAMPLES:-example_basic}"

################################################################################
# Dependencies Configuration
################################################################################

# Required addon repositories
# Format: "repo_url|branch|addon_name"
REQUIRED_ADDONS=(
    "https://github.com/pierrep/ofxOMXPlayer.git|SeekingFix|ofxOMXPlayer"
    "https://github.com/pierrep/ofxVideoSync.git|master|ofxVideoSync"
)

# Optional addon repositories (only installed if INSTALL_OPTIONAL_ADDONS=true)
INSTALL_OPTIONAL_ADDONS="${INSTALL_OPTIONAL_ADDONS:-true}"
OPTIONAL_ADDONS=(
    "https://github.com/npisanti/ofxPDSP.git|master|ofxPDSP"
)

# System packages to install
SYSTEM_PACKAGES=(
    # Build essentials
    "build-essential"
    "git"
    "cmake"
    "pkg-config"

    # OpenGL and graphics
    "libgles2-mesa-dev"
    "libglfw3-dev"
    "libegl1-mesa-dev"

    # GStreamer
    "libgstreamer1.0-dev"
    "libgstreamer-plugins-base1.0-dev"
    "libgstreamer-plugins-good1.0-dev"
    "libgstreamer-plugins-bad1.0-dev"
    "gstreamer1.0-plugins-base"
    "gstreamer1.0-plugins-good"
    "gstreamer1.0-plugins-bad"
    "gstreamer1.0-plugins-ugly"
    "gstreamer1.0-libav"
    "gstreamer1.0-alsa"
    "gstreamer1.0-omx-rpi"
    "gstreamer1.0-omx-rpi-config"

    # Audio
    "libasound2-dev"
    "libpulse-dev"
    "alsa-utils"

    # Additional libraries
    "libfreetype6-dev"
    "libfreeimage-dev"
    "libfontconfig1-dev"
    "libcairo2-dev"
    "libglm-dev"
    "libxrandr-dev"
    "libxi-dev"
    "libxcursor-dev"
    "libxinerama-dev"
    "libxmu-dev"
    "libboost-all-dev"

    # Utilities
    "curl"
    "wget"
    "unzip"
    "rsync"
    "htop"
)

################################################################################
# Display Configuration
################################################################################

# Force X11 instead of Wayland
FORCE_X11="${FORCE_X11:-true}"

# Auto-login to desktop
ENABLE_AUTOLOGIN="${ENABLE_AUTOLOGIN:-true}"

# Screen resolution (optional, leave empty for auto-detect)
SCREEN_WIDTH="${SCREEN_WIDTH:-}"
SCREEN_HEIGHT="${SCREEN_HEIGHT:-}"

# HDMI settings
HDMI_FORCE_HOTPLUG="${HDMI_FORCE_HOTPLUG:-1}"
HDMI_DRIVE="${HDMI_DRIVE:-2}"  # 1=DVI, 2=HDMI with audio

################################################################################
# Auto-start Configuration
################################################################################

# Enable auto-start of ofxPiMapper on boot
AUTOSTART_ENABLED="${AUTOSTART_ENABLED:-false}"

# Which example to auto-start
AUTOSTART_PROJECT="${AUTOSTART_PROJECT:-example_simpler}"

# Launch in fullscreen mode
AUTOSTART_FULLSCREEN="${AUTOSTART_FULLSCREEN:-true}"

# Delay before starting (seconds, allows system to settle)
AUTOSTART_DELAY="${AUTOSTART_DELAY:-10}"

# Restart on crash
AUTOSTART_RESTART_ON_CRASH="${AUTOSTART_RESTART_ON_CRASH:-true}"

################################################################################
# Network Configuration
################################################################################

# Enable SSH server
ENABLE_SSH="${ENABLE_SSH:-true}"

# Enable VNC server
ENABLE_VNC="${ENABLE_VNC:-false}"

# WiFi configuration (leave empty to skip)
WIFI_SSID="${WIFI_SSID:-}"
WIFI_PASSWORD="${WIFI_PASSWORD:-}"
WIFI_COUNTRY="${WIFI_COUNTRY:-US}"

################################################################################
# Performance Tuning
################################################################################

# GPU memory split (MB) - recommended: 256 for graphics work
GPU_MEM="${GPU_MEM:-256}"

# CPU governor: "ondemand", "performance", or "powersave"
CPU_GOVERNOR="${CPU_GOVERNOR:-performance}"

# Disable swap for better performance (SD card longevity)
DISABLE_SWAP="${DISABLE_SWAP:-true}"

# Overclock settings (use with caution, may void warranty)
ENABLE_OVERCLOCK="${ENABLE_OVERCLOCK:-false}"
OVERCLOCK_ARM_FREQ="${OVERCLOCK_ARM_FREQ:-2000}"
OVERCLOCK_GPU_FREQ="${OVERCLOCK_GPU_FREQ:-750}"

################################################################################
# Build Options
################################################################################

# Clean build (remove all intermediate files)
CLEAN_BUILD="${CLEAN_BUILD:-false}"

# Compress final image
COMPRESS_IMAGE="${COMPRESS_IMAGE:-true}"

# Generate SHA256 checksums
GENERATE_CHECKSUMS="${GENERATE_CHECKSUMS:-true}"

# Include sample media files
INCLUDE_SAMPLE_MEDIA="${INCLUDE_SAMPLE_MEDIA:-true}"

# Enable build logging
ENABLE_BUILD_LOG="${ENABLE_BUILD_LOG:-true}"
BUILD_LOG_PATH="${BUILD_LOG_PATH:-deploy/build.log}"

################################################################################
# Advanced Options
################################################################################

# Number of parallel jobs for compilation (0 = auto-detect)
PARALLEL_JOBS="${PARALLEL_JOBS:-0}"

# Filesystem type: "ext4" or "f2fs"
FILESYSTEM_TYPE="${FILESYSTEM_TYPE:-ext4}"

# Minimal size (shrink image to minimal size)
SHRINK_IMAGE="${SHRINK_IMAGE:-true}"

# Custom scripts to run after installation (array of paths)
POST_INSTALL_SCRIPTS=()

################################################################################
# DO NOT EDIT BELOW THIS LINE
# (Unless you know what you're doing)
################################################################################

# Calculate parallel jobs if not set
if [ "$PARALLEL_JOBS" -eq 0 ]; then
    PARALLEL_JOBS=$(nproc 2>/dev/null || echo 2)
fi

# Validate architecture and platform match
if [ "$ARCHITECTURE" = "armhf" ] && [ "$OF_PLATFORM" != "linuxarmv7l" ]; then
    echo "WARNING: Architecture mismatch detected. Setting OF_PLATFORM=linuxarmv7l"
    OF_PLATFORM="linuxarmv7l"
fi

if [ "$ARCHITECTURE" = "arm64" ] && [ "$OF_PLATFORM" != "linuxaarch64" ]; then
    echo "WARNING: Architecture mismatch detected. Setting OF_PLATFORM=linuxaarch64"
    OF_PLATFORM="linuxaarch64"
fi

# Export all variables for use in subscripts
export RPI_USERNAME RPI_PASSWORD HOSTNAME TIMEZONE LOCALE KEYBOARD_LAYOUT
export BASE_IMAGE ARCHITECTURE RPI_OS_RELEASE
export OF_VERSION OF_PLATFORM OF_DOWNLOAD_URL OF_ROOT
export OFXPIMAPPER_REPO OFXPIMAPPER_BRANCH COMPILE_EXAMPLE ADDITIONAL_EXAMPLES
export FORCE_X11 ENABLE_AUTOLOGIN SCREEN_WIDTH SCREEN_HEIGHT
export HDMI_FORCE_HOTPLUG HDMI_DRIVE
export AUTOSTART_ENABLED AUTOSTART_PROJECT AUTOSTART_FULLSCREEN
export AUTOSTART_DELAY AUTOSTART_RESTART_ON_CRASH
export ENABLE_SSH ENABLE_VNC WIFI_SSID WIFI_PASSWORD WIFI_COUNTRY
export GPU_MEM CPU_GOVERNOR DISABLE_SWAP
export ENABLE_OVERCLOCK OVERCLOCK_ARM_FREQ OVERCLOCK_GPU_FREQ
export CLEAN_BUILD COMPRESS_IMAGE GENERATE_CHECKSUMS INCLUDE_SAMPLE_MEDIA
export ENABLE_BUILD_LOG BUILD_LOG_PATH
export PARALLEL_JOBS FILESYSTEM_TYPE SHRINK_IMAGE
export INSTALL_OPTIONAL_ADDONS

echo "Configuration loaded: ofxPiMapper Build System"
echo "  Username: $RPI_USERNAME"
echo "  Hostname: $HOSTNAME"
echo "  Architecture: $ARCHITECTURE"
echo "  Base Image: $BASE_IMAGE"
echo "  openFrameworks: $OF_VERSION ($OF_PLATFORM)"
echo "  Auto-start: $AUTOSTART_ENABLED"
